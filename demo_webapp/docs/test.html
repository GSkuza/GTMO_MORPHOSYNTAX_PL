<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>GTM√ò API Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        button { padding: 10px 20px; margin: 5px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ GTM√ò API Test Page</h1>
    <p>Backend URL: <strong>http://localhost:8000</strong></p>

    <div id="results"></div>

    <script>
        const API_URL = 'http://localhost:8000';
        const resultsDiv = document.getElementById('results');

        function addTest(name, status, message, details = '') {
            const div = document.createElement('div');
            div.className = `test ${status}`;
            div.innerHTML = `
                <h3>${status === 'success' ? '‚úÖ' : '‚ùå'} ${name}</h3>
                <p>${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            resultsDiv.appendChild(div);
        }

        async function test1_HealthCheck() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();

                if (response.ok) {
                    addTest(
                        'Test 1: Health Check',
                        'success',
                        'Backend is healthy',
                        JSON.stringify(data, null, 2)
                    );
                } else {
                    addTest('Test 1: Health Check', 'error', `Status: ${response.status}`);
                }
            } catch (error) {
                addTest('Test 1: Health Check', 'error', error.message);
            }
        }

        async function test2_Root() {
            try {
                const response = await fetch(`${API_URL}/`);
                const data = await response.json();

                if (response.ok) {
                    addTest(
                        'Test 2: Root Endpoint',
                        'success',
                        'Root endpoint working',
                        JSON.stringify(data, null, 2)
                    );
                } else {
                    addTest('Test 2: Root Endpoint', 'error', `Status: ${response.status}`);
                }
            } catch (error) {
                addTest('Test 2: Root Endpoint', 'error', error.message);
            }
        }

        async function test3_CORS() {
            try {
                const response = await fetch(`${API_URL}/health`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Origin': 'http://localhost:8080'
                    }
                });

                const corsHeader = response.headers.get('Access-Control-Allow-Origin');

                if (corsHeader) {
                    addTest(
                        'Test 3: CORS Headers',
                        'success',
                        `CORS enabled: ${corsHeader}`,
                        `All CORS headers:\n${Array.from(response.headers.entries()).map(([k,v]) => `${k}: ${v}`).join('\n')}`
                    );
                } else {
                    addTest('Test 3: CORS Headers', 'error', 'No CORS headers found');
                }
            } catch (error) {
                addTest('Test 3: CORS Headers', 'error', error.message);
            }
        }

        async function test4_FileUpload() {
            try {
                // Create a test file
                const testText = "Art. 1. Test przepisu prawnego.";
                const blob = new Blob([testText], { type: 'text/plain' });
                const file = new File([blob], 'test.txt', { type: 'text/plain' });

                const formData = new FormData();
                formData.append('file', file);

                addTest(
                    'Test 4: File Upload',
                    'success',
                    '‚è≥ Starting analysis (this may take 2-5 minutes)...',
                    `File: ${file.name}\nSize: ${file.size} bytes\nText: "${testText}"`
                );

                const response = await fetch(`${API_URL}/analyze?use_llm=false`, {
                    method: 'POST',
                    body: formData,
                    mode: 'cors'
                });

                console.log('Upload response status:', response.status);
                const data = await response.json();

                if (response.ok && data.success) {
                    addTest(
                        'Test 4: File Upload - COMPLETE',
                        'success',
                        'Analysis completed successfully!',
                        JSON.stringify({
                            metrics_count: data.metrics_table?.length || 0,
                            avg_SA: data.aggregate_stats?.average_SA || 0,
                            first_row: data.metrics_table?.[0] || 'N/A'
                        }, null, 2)
                    );
                } else {
                    addTest('Test 4: File Upload', 'error', data.message || 'Upload failed', JSON.stringify(data, null, 2));
                }
            } catch (error) {
                addTest('Test 4: File Upload', 'error', error.message, error.stack);
            }
        }

        // Run tests
        (async () => {
            await test1_HealthCheck();
            await test2_Root();
            await test3_CORS();

            // Ask before running the long test
            const div = document.createElement('div');
            div.className = 'test';
            div.innerHTML = `
                <h3>Test 4: File Upload Test</h3>
                <p>This test will take 2-5 minutes. Click to start:</p>
                <button onclick="test4_FileUpload()">‚ñ∂Ô∏è Run Upload Test</button>
            `;
            resultsDiv.appendChild(div);
        })();
    </script>
</body>
</html>
